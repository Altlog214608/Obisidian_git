너가 제공한 코드는 **매니폴드(펌프) 제어 시스템 소프트웨어**이며, PC에서 펌프 제어 하드웨어로 RS232를 통해 MODBUS 명령을 송수신하는 구조야. 전체 구조와 동작 원리를 아래와 같이 분석했어.

---

## ✅ 전체 구성 요약

|구성 요소|설명|
|---|---|
|**`ControlPumpNF.c`**|메인 프로그램 (UI, 초기화, 명령 실행)|
|**`ConfigCOM.c/h`**|시리얼 포트 설정 및 통신 (COM 포트, CRC, SLIP 등)|
|**`FunctionSerial.c/h`**|SLIP 인코딩/디코딩, CRC 체크 등 통신 보조 함수|
|**`MODBUS.c/h`**|MODBUS 프로토콜에 따른 데이터 송수신|
|**`*.uir / uc_control_level_32.h`**|CVI 기반 UI 관련 코드 (펌프 제어 패널)|

---

## ⚙️ 동작 흐름 요약

### 1. 시작 및 초기화 (`ControlPumpNF.c`)

```c
main → InitProcess() → ReadConfigCom → ActivateCom → InitProcess_NF
```

- `ReadConfigCom`: `ConfigCom.cfg` 설정 파일 읽어 포트 정보 등 설정
    
- `ActivateCom`: 시리얼 포트 오픈 및 콜백 설치
    
- `InitProcess_NF`: 초기 상태 조회
    
    - `ReadRegisters_NF`: 펌프 상태 레지스터 읽기
        
    - `WriteSingleRes_NF`: 펌프 제어 방식 설정 (토마스 펌프)
        

---

### 2. 명령 전송 (Run 버튼 등 UI 이벤트)

#### 1) 실행 명령 전송 (`cmdid = 1, 2, 4`)

```c
WriteMultiRes_NF(NF_CMD, 8)
```

- scent 번호, power level, 시간, delay 등을 MODBUS 명령으로 패킷화 후 전송
    

#### 2) 단일 쓰기 (`WriteSingleRes_NF`)

```c
NF_CTP ← 1  // Thomas 펌프 제어 방식 설정
```

#### 3) 데이터 읽기 (`ReadRegisters_NF`)

```c
NF_CGP ← pressure (input register)
NF_TMP ← temperature (2-word)
```

---

### 3. 통신 처리 (`ConfigCOM.c`)

- `SendToCom`: CRC16 또는 Modbus CRC 붙이고 전송
    
- `ReadFromCom`: terminator 또는 버퍼 길이에 따라 수신
    
- `DecodePacket`: 수신된 MODBUS 데이터 해석 (ex. 압력값 계산, UI 표시)
    

---

## 🔐 통신 상세

|항목|설명|
|---|---|
|**프로토콜**|MODBUS RTU (0x03/0x06/0x10 등)|
|**전송 형식**|CRC16 또는 MODBUS CRC 포함|
|**SLIP 지원**|옵션: SLIP 인코딩 (0xC0, 0xDB 등 escaping 방식)|
|**구성 요소**|`send[]`, `read[]` 버퍼 사용, `s_serial` 구조체 전역 선언|

---

## 🧠 주요 구조체

### `struct s_SERIAL`

```c
unsigned char read[512], send[512];
int port, baudrate, parity, databits, stopbits;
double timeout;
char starter, terminator;
int protocol, crc, mode, debug;
```

### `S_SCENT`

```c
int cmdid;      // 명령 ID (1=run, 2=clean, 3=stop, 4=run+clean)
int scentno;    // 향 번호
int level;      // 출력 세기 (0–31)
int runtime;    // 펌프 작동 시간 (초)
```

---

## 🧪 예시 시나리오: 향 분사

1. 사용자 `cmdid=1`, `scentno=2`, `level=20`, `runtime=5` 입력
    
2. `WriteMultiRes_NF()` 호출
    
3. 패킷 구성:
    
    ```
    [0x01][0x10][0x10][0x68] ... 향 번호/펌프 출력/시간/딜레이 등
    ```
    
4. `SendToCom()`으로 시리얼 송신 → 장치 응답
    
5. `ReadFromCom()` 수신 후 `DecodePacket()` → `OK` 또는 `에러 메시지` 표시
    

---

## 📌 요약

- **하드웨어 통신**: RS232 기반, MODBUS RTU 사용
    
- **주요 기능**:
    
    - 향 분사 / 세정 / 정지 명령
        
    - 현재 압력 및 온도 상태 조회
        
- **코드 구조**: CVI 기반 UI + 시리얼 드라이버 + MODBUS 송수신 처리
    
- **통신 안정성 확보**: CRC, SLIP 인코딩 등 적용
    

---
